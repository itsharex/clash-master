name: Create Dev Preview Branch

on:
  pull_request:
    types: [closed]
    branches: [dev]

permissions:
  contents: write
  pull-requests: read

jobs:
  create-preview-branch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Derive preview branch name
      id: derive
      shell: bash
      run: |
        head_ref="${{ github.event.pull_request.head.ref }}"
        merge_sha="${{ github.event.pull_request.merge_commit_sha }}"

        if [[ -z "${merge_sha}" || "${merge_sha}" == "null" ]]; then
          echo "::error::Missing merge commit SHA on merged PR."
          exit 1
        fi

        suffix="${head_ref}"
        for prefix in "feat/" "feature/" "fix/" "hotfix/" "bugfix/" "chore/" "refactor/" "dev/"; do
          if [[ "${suffix}" == "${prefix}"* ]]; then
            suffix="${suffix#${prefix}}"
            break
          fi
        done

        safe="$(echo "${suffix}" \
          | tr '[:upper:]' '[:lower:]' \
          | sed 's#[^a-z0-9._/-]#-#g' \
          | sed 's#//*#/#g' \
          | sed 's#^/##; s#/$##')"

        if [[ -z "${safe}" ]]; then
          safe="preview-${{ github.event.pull_request.number }}"
        fi

        preview_branch="dev/${safe}"
        echo "preview_branch=${preview_branch}" >> "$GITHUB_OUTPUT"
        echo "merge_sha=${merge_sha}" >> "$GITHUB_OUTPUT"

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create or update preview branch
      shell: bash
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git fetch --no-tags origin "${{ steps.derive.outputs.merge_sha }}"
        git checkout --detach "${{ steps.derive.outputs.merge_sha }}"

        git push origin "HEAD:refs/heads/${{ steps.derive.outputs.preview_branch }}" --force

    - name: Summary
      run: |
        echo "Created/updated preview branch: \`${{ steps.derive.outputs.preview_branch }}\`" >> "$GITHUB_STEP_SUMMARY"
        echo "From merge commit: \`${{ steps.derive.outputs.merge_sha }}\`" >> "$GITHUB_STEP_SUMMARY"
